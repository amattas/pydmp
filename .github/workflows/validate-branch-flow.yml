name: Validate Branch Flow

permissions:
  contents: read

on:
  pull_request:
    branches:
      - 'release/**'

jobs:
  validate-source:
    name: Validate PR Source Branch
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - name: Check branch flow rules
        shell: bash
        run: |
          set -Eeuo pipefail

          TARGET="${{ github.base_ref }}"
          SOURCE="${{ github.head_ref }}"

          echo "Validating branch flow..."
          echo "   Source: $SOURCE"
          echo "   Target: $TARGET"
          echo "" | tee -a "$GITHUB_STEP_SUMMARY"
          {
            echo "## Validating branch flow"
            echo "- Source: $SOURCE"
            echo "- Target: $TARGET"
          } >> "$GITHUB_STEP_SUMMARY"

          # Allowed targets:
          #   - release/x.y.z
          #   - release/x.y.z-<suffix>
          #   - release/latest

          # Regex for version or prerelease: release/1.2.3 or release/1.2.3-alpha.1
          if [[ "$TARGET" =~ ^release/[0-9]+\.[0-9]+\.[0-9]+(-[-0-9A-Za-z.]+)?$ ]]; then
            echo "Rule: Version release branches (release/x.y.z and release/x.y.z-*) can only accept PRs from 'main'"
            if [[ "$SOURCE" != "main" ]]; then
              echo "FAILED: Source branch must be 'main', got '$SOURCE'"
              echo ""
              echo "Valid flow: main -> release/x.y.z[-pre] -> release/latest"
              {
                echo "## Validate Branch Flow - FAILED"
                echo "- Rule: version/prerelease targets require 'main' source"
                echo "- Source: $SOURCE"
                echo "- Target: $TARGET"
                echo "- Result: FAILED"
              } >> "$GITHUB_STEP_SUMMARY"
              exit 1
            fi
            echo "PASSED: Valid flow from main to version/prerelease release branch"
            {
              echo "## Validate Branch Flow - PASSED"
              echo "- Rule: version/prerelease target"
              echo "- Source: $SOURCE"
              echo "- Target: $TARGET"
              echo "- Result: PASS"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          if [[ "$TARGET" == "release/latest" ]]; then
            echo "Rule: release/latest can only accept PRs from version release branches (release/x.y.z or release/x.y.z-*)"
            if [[ ! "$SOURCE" =~ ^release/[0-9]+\.[0-9]+\.[0-9]+(-[-0-9A-Za-z.]+)?$ ]]; then
              echo "FAILED: Source branch must be 'release/x.y.z' or 'release/x.y.z-*', got '$SOURCE'"
              echo ""
              echo "Valid flow: main -> release/x.y.z[-pre] -> release/latest"
              {
                echo "## Validate Branch Flow - FAILED"
                echo "- Rule: 'release/latest' requires version release source"
                echo "- Source: $SOURCE"
                echo "- Target: $TARGET"
                echo "- Result: FAILED"
              } >> "$GITHUB_STEP_SUMMARY"
              exit 1
            fi
            echo "PASSED: Valid flow from version release to latest"
            {
              echo "## Validate Branch Flow - PASSED"
              echo "- Rule: latest target"
              echo "- Source: $SOURCE"
              echo "- Target: $TARGET"
              echo "- Result: PASS"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Any other release/* target is not allowed
          echo "FAILED: Target branch not allowed for release workflows: $TARGET"
          echo "Allowed targets: release/x.y.z, release/x.y.z-*, release/latest"
          {
            echo "## Validate Branch Flow - FAILED"
            echo "- Rule: target must be release/x.y.z, release/x.y.z-*, or release/latest"
            echo "- Source: $SOURCE"
            echo "- Target: $TARGET"
            echo "- Result: FAILED"
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1
